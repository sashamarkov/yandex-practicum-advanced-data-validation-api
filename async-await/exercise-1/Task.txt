Ð’ ÑÑ‚Ð¾Ð¼ Ñ‚Ñ€ÐµÐ½Ð°Ð¶Ñ‘Ñ€Ðµ Ð²Ð°Ð¼ Ð½ÑƒÐ¶Ð½Ð¾ Ð²Ñ‹Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ ÐºÐ¾Ñ‚Ð¸ÐºÐ¾Ð² Ð½Ð° Ð²Ð¾Ð»ÑŽ, ÐºÐ»Ð¸ÐºÐ°Ñ Ð¿Ð¾ Ð²Ñ‹Ð´ÐµÐ»ÐµÐ½Ð½Ð¾Ð¹ Ð¾Ð±Ð»Ð°ÑÑ‚Ð¸. ÐšÐ¾Ñ‚Ð¸ÐºÐ¸ Ð²ÐµÑÐµÐ»Ð¾ Ñ€Ð°Ð·Ð±ÐµÐ³Ð°ÑŽÑ‚ÑÑ, Ð° Ð² ÑÑ‚Ð¾Ð¼ Ð¸Ð¼ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÑŽÑ‚ Ð¿Ñ€Ð¾Ð¼Ð¸ÑÑ‹. ÐÐ¾ Ð·Ð° Ð¾ÐºÐ½Ð¾Ð¼ 21-Ð¹ Ð²ÐµÐº, Ð¿Ð¾ÑÑ‚Ð¾Ð¼Ñƒ Ð½ÑƒÐ¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ð½Ð° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ async/await. Ð’ ÑÑ‚Ð¾Ð¼ Ð·Ð°Ð´Ð°Ð½Ð¸Ð¸ Ð²Ð°Ð¼ Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒ ÐºÐ¾Ð´, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ‚Ñ€ÐµÐ½Ð°Ð¶Ñ‘Ñ€ Ð·Ð°Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð». Ð¢Ñ€ÐµÐ½Ð°Ð¶Ñ‘Ñ€ ÑƒÐ¶Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚, Ð½Ð¾ Ð²Ð°Ð¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð¿Ñ€Ð¾Ð¼Ð¸ÑÑ‹ Ð½Ð° async/await, Ð¸ Ñ‚Ð¾Ð³Ð´Ð° ÐºÐ¾Ð´ ÑÑ‚Ð°Ð½ÐµÑ‚ Ð¿Ñ€Ð¾Ñ‰Ðµ Ð¸ Ð¿Ð¾Ð½ÑÑ‚Ð½ÐµÐµ.

---
ÐŸÐµÑ€ÐµÐ´ÐµÐ»Ð°Ð¹Ñ‚Ðµ Ð²ÑÐµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð¸ ÐºÐ¾Ð»Ð»Ð±ÐµÐºÐ¸ Ð² async-Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚
- Ð’Ñ‹Ð´ÐµÐ»Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ return Ð¸ Ð´Ð»Ñ throw
- ÐŸÐ¾Ð¼Ð½Ð¸Ñ‚Ðµ Ð¾ try .. catch
- ÐžÐ±ÑŠÐµÐ´Ð¸Ð½Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾Ð¼Ð¸ÑÑ‹ Ð² ÑÐ¿Ð¸ÑÐ¾Ðº Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ ÐºÐ¾Ñ‚Ð¸ÐºÐ¾Ð² Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ async-Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸.

---
index.js

const container = document.querySelector(".container")

function addDiv(x, y) {
    return new Promise((resolve, reject) => {
        if(container.childNodes.length > 128){
            return reject("too many cats")
        }
        const newDiv = document.createElement('div');
        newDiv.classList.add('inner-div');

        newDiv.style.left = `${x}px`;
        newDiv.style.top = `${y}px`;

        resolve(newDiv)
    })
}

container.onclick = ev => {
    addDiv(ev.x, ev.y)
        .then(divElem => {
            divElem.textContent = "ðŸ±"
            divElem.setAttribute("dx", (10 * Math.random() - 5))
            divElem.setAttribute("dy", (10 * Math.random() - 5))
            container.appendChild(divElem);
        })
        .catch(err => console.error("cant add cat", err))
}

function drawFrame(prevDate){
    let now = Date.now()
    let dt = Math.max(1, now - prevDate)
    let containerRect = container.getBoundingClientRect();
    let calcPromises = [];
    container.childNodes.forEach(node => {
        if(node instanceof Element && node.classList.contains("inner-div")){
            let calcPromise = new Promise((resolve, reject) => {
                let dx = parseFloat(node.getAttribute('dx'))
                let dy = parseFloat(node.getAttribute('dy'))
                node.style.left = `${parseFloat(node.style.left) + 10 * (dx * dt / 1000)}px`
                node.style.top = `${parseFloat(node.style.top) + 10 * (dy * dt / 1000)}px`

                let nodeRect = node.getBoundingClientRect();
                if(nodeRect.left > containerRect.right 
                    || nodeRect.right < containerRect.left
                    || nodeRect.bottom < containerRect.top
                    || nodeRect.top > containerRect.bottom) {
                    reject({err: "cat run away", node})
                } else {
                    resolve({node})
                }
            })
            calcPromises.push(calcPromise)
        }
    })
    Promise.allSettled(calcPromises).then(res => {
        res.filter (nodeRes => nodeRes.status == 'rejected')
            .forEach(nodeRes => container.removeChild(nodeRes.reason.node))
    }).then(() => requestAnimationFrame(() => drawFrame(now)))
}

document.addEventListener('DOMContentLoaded', () => {
    drawFrame(Date.now())
})